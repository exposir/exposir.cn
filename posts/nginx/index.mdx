---
title: Nginx
date: 2020-06-15
responsive: true
fullScreen: true
---

> “Nginx 是一款轻量级的 HTTP 服务器，采用事件驱动的异步非阻塞处理方式框架，这让其具有极好的 IO 性能，时常用于服务端的反向代理和负载均衡。”

## 反向代理

什么是反向代理？ 互联网应用基本都基于 CS 基本结构，即 client 端和 server 端。代理其实就是在 client 端和真正的 server 端之前增加一层提供特定服务的服务器，即代理服务器。

### 正向代理

反向代理不好理解，**正向代理**大家总有用过，翻墙工具其实就是一个正向代理工具。它会把 们访问墙外服务器 server 的网页请求，代理到一个可以访问该网站的代理服务器 proxy，这个代理服务器 proxy 把墙外服务器 server 上的网页内容获取，再转发给客户。、

概括说：就是客户端和代理服务器可以直接互相访问，属于一个 LAN（局域网）；代理对用户是**非透明**的，即用户需要自己操作或者感知得到自己的请求被发送到代理服务器；代理服务器通过**代理用户端的请求**来向域外服务器请求响应内容。

### 反向代理

在**反向代理**中（事实上，这种情况基本发生在所有的大型网站的页面请求中），客户端发送的请求，想要访问 server 服务器上的内容。但将被发送到一个代理服务器 proxy，这个代理服务器将把请求代理到和自己属于同一个 LAN 下的内部服务器上，而用户真正想获得的内容就储存在这些内部服务器上。看到区别了吗，这里 proxy 服务器代理的并不是客户，而是服务器，即向外部客户端提供了一个统一的代理入口，客户端的请求，都先经过这个 proxy 服务器，至于在内网真正访问哪台服务器内容，由这个 proxy 去控制。一般代理是指代理客户端，而这里代理的对象是服务器，这就是“反向”这个词的意思。Nginx 就是来充当这个 proxy 的作用。 概括说：就是代理服务器和真正 server 服务器可以直接互相访问，属于一个 LAN（服务器内网）；代理对用户是**透明**的，即无感知。不论加不加这个反向代理，用户都是通过相同的请求进行的，且不需要任何额外的操作；代理服务器通过**代理内部服务器**接受域外客户端的请求，并将请求发送到对应的内部服务器上。

### 为什么要 Nginx 反向代理

1. 安全及权限。可以看出，使用反向代理后，用户端将无法直接通过请求访问真正的内容服务器，而必须首先通过 Nginx。可以通过在 Nginx 层上将危险或者没有权限的请求内容过滤掉，从而保证了服务器的安全。
2. 负载均衡。例如一个网站的内容被部署在若干台服务器上，可以把这些机子看成一个集群，那么 Nginx 可以将接收到的客户端请求“均匀地”分配到这个集群中所有的服务器上（内部模块提供了多种负载均衡算法），从而实现服务器压力的负载均衡。此外，nginx 还带有健康检查功能（服务器心跳检查），会定期轮询向集群里的所有服务器发送健康检查请求，来检查集群中是否有服务器处于异常状态，一旦发现某台服务器异常，那么在以后代理进来的客户端请求都不会被发送到该服务器上（直到后面的健康检查发现该服务器恢复正常），从而保证客户端访问的稳定性。

## 前端可以用 Nginx 做些什么

### 1.快速实现简单的访问控制

经常会遇到希望网站让某些特定用户的群体（比如只让公司内网）访问，或者控制某个 uri 不让人访问。Nginx 配置如下：

```js
location / {
deny 192.168.1.100;
allow 192.168.1.10/200;
allow 10.110.50.16;
deny all;
}
```

其实 deny 和 allow 是**ngx_http_access_module**模块（已内置）中的语法。采用的是从上到下匹配方式，匹配到就跳出不再继续匹配。上述配置的意思就是，首先禁止 192.168.1.100 访问，然后允许 192.168.1.10-200 ip 段内的访问（排除 192.168.1.100），同时允许 10.110.50.16 这个单独 ip 的访问，剩下未匹配到的全部禁止访问。实际生产中，经常和**ngx_http_geo_module**模块（可以更好地管理 ip 地址表，已内置）配合使用。

### 2.解决跨域

### 3.适配 PC 与移动环境

现在很多网站都存在 PC 站和 H5 站两个站点，因此根据用户的浏览环境自动切换站点是很常见的需求。Nginx 可以通过内置变量$http_user_agent，获取到请求客户端的 userAgent，从而知道用户处于移动端还是 PC，进而控制重定向到 H5 站还是 PC 站。

```js
    location / {
        # 移动、pc设备适配
        if ($http_user_agent ~* '(Android|webOS|iPhone|iPod|BlackBerry)') {
            set $mobile_request '1';
        }
        if ($mobile_request = '1') {
 rewrite ^.+ http://mysite-base-H5.com;
        }
    }
```

### 4.合并请求

前端性能优化中重要一点就是尽量减少 http 资源请求的数量。通过 [nginx-http-concat](https://github.com/alibaba/nginx-http-concat) 模块（淘宝开发的第三方模块，需要单独安装）用一种特殊的请求 url 规则，前端可以将多个资源的请求合并成一个请求，后台 Nginx 会获取各个资源并拼接成一个结果进行返回。

### 5.图片处理

在前端开发中，经常需要不同尺寸的图片。现在的云储存基本对图片都提供有处理服务（一般是通过在图片链接上加参数）。其实用 Nginx，可以通过几十行配置，搭建出一个属于自己的本地图片处理服务，完全能够满足日常对图片的裁剪/缩放/旋转/图片品质等处理需求。要用到 [ngx_http_image_filter_module](http://nginx.org/en/docs/http/ngx_http_image_filter_module.html) 模块。这个模块是非基本模块，需要安装。

```js
    # 图片缩放处理
    # 这里约定的图片处理url格式：以 mysite-base.com/img/路径访问
    location ~* /img/(.+)$ {
        alias /Users/cc/Desktop/server/static/image/$1; #图片服务端储存地址
        set $width -; #图片宽度默认值
        set $height -; #图片高度默认值
        if ($arg_width != "") {
            set $width $arg_width;
        }
        if ($arg_height != "") {
            set $height $arg_height;
        }
        image_filter resize $width $height; #设置图片宽高
        image_filter_buffer 10M;   #设置Nginx读取图片的最大buffer。
        image_filter_interlace on; #是否开启图片图像隔行扫描
        error_page 415 = 415.png; #图片处理错误提示图，例如缩放参数不是数字
    }
```

这里只是最基本的配置。此外，可以通过 proxy_cache 配置 Nginx 缓存，避免每次请求都重新处理图片，减少 Nginx 服务器处理压力；还以可以通过和 [nginx-upload-module](http://www.grid.net.ru/nginx/upload.en.html) 一起使用加入图片上传的功能等。

### 6.页面内容修改

Nginx 可以通过向页面底部或者顶部插入额外的 css 和 js 文件，从而实现修改页面内容。这个功能需要额外模块的支持，例如： [nginx_http_footer_filter](https://github.com/alibaba/nginx-http-footer-filter) 或者 [ngx_http_addition_module](http://nginx.org/en/docs/http/ngx_http_addition_module.html) (都需要安装)。 工作中，经常需要切换各种测试环境，而通过 switchhosts 等工具切换后，有时还需要清理浏览器 dns 缓存。可以通过页面内容修改+Nginx 反向代理来实现轻松快捷的环境切换。 这里首先在本地编写一段 js 代码（switchhost.js），里面的逻辑是：在页面插入 hosts 切换菜单以及点击具体某个环境时，将该 host 的 ip 和 hostname 储存在 cookie 中，最后刷新页面；接着编写一段 css 代码（switchhost.css）用来设置该 hosts 切换菜单的样式。 然后 Nginx 脚本配置：

```js
server {
        listen 80;
        listen  443 ssl;
        expires -1;
        # 想要代理的域名
        server_name m-element.kaola.com;
        set $root /Users/cc/Desktop/server;
        charset utf-8;
        ssl_certificate      /usr/local/etc/nginx/m-element.kaola.com.crt;
        ssl_certificate_key  /usr/local/etc/nginx/m-element.kaola.com.key;

        # 设置默认$switch_host，一般默认为线上host，这里的1.1.1.1随便写的
        set $switch_host '1.1.1.1';
        # 设置默认$switch_hostname，一般默认为线上'online'
        set $switch_hostname '';
        # 从cookie中获取环境ip
        if ($http_cookie ~* "switch_host=(.+?)(?=;|$)") {
            set $switch_host $1;
        }

        # 从cookie中获取环境名
        if ($http_cookie ~* "switch_hostname=(.+?)(?=;|$)") {
            set $switch_hostname $1;
        }

        location / {
            expires -1;
            index index.html;
            proxy_set_header Host $host;
            #把html页面的gzip压缩去掉，不然sub_filter无法替换内容
            proxy_set_header Accept-Encoding '';
            #反向代理到实际服务器ip
            proxy_pass  http://$switch_host:80;
            #全部替换
            sub_filter_once off;
            #ngx_http_addition_module模块替换内容。
            # 这里在头部插入一段css，内容是hosts切换菜单的css样式
            sub_filter '</head>' '</head><link rel="stylesheet" type="text/css" media="screen" href="/local/switchhost.css" />';
            #将页面中的'网易考拉'文字后面加上环境名，便于开发识别目前环境
            sub_filter '网易考拉' '网易考拉:${switch_hostname}';
            #这里用了另一个模块nginx_http_footer_filter，其实上面的模块就行，只是为了展示用法
            # 最后插入一段js，内容是hosts切换菜单的js逻辑
            set $injected '<script language="javascript" src="/local/switchhost.js"></script>';
            footer '${injected}';
        }
        # 对于/local/请求，优先匹配本地文件
        # 所以上面的/local/switchhost.css，/local/switchhost.js会从本地获取
        location ^~ /local/ {
            root $root;
        }
}
```

这个功能其实为 Nginx 在前端开发中的应用提供了无限可能。例如，可以通过区分本地、测试和线上环境，为本地/测试环境页面增加很多开发辅助功能：给本地页面加一个常驻二维码便于手机端扫码调试；本地调试线上页面时，在 js 文件底部塞入 sourceMappingURL，便于本地 debug 等等
